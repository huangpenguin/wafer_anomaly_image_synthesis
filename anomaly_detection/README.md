# ベベル観察画像欠陥検出／分類 検証用プログラム
機械学習によるベベル観察画像の欠陥検出手法、及び欠陥分類手法を検証するためのプログラム。  
※ 以降、検証用プログラム又は本プログラムと略して記載する。
<br><hr>

## 1. フォルダ構成
```
bevel-ml
 ├── bevel_ml                    # 検証用プログラムの本体を格納したフォルダ
 ├── config                      # 設定ファイルを格納するためのフォルダ
 │   ├── case_mul_clf            # 分類モデル(多クラス)の設定フォルダ
 │   ├── case_bin_clf            # 二値分類モデルの設定フォルダ
 │   ├── case_ad                 # 良品学習モデルの設定フォルダ
 │   ├── config_mul_clf.yaml     # 分類モデル(多クラス)の設定ファイル
 │   ├── config_bin_clf.yaml     # 二値分類モデルの設定ファイル
 │   └── config_ad.yaml          # 良品学習モデルの設定ファイル
 ├── data
 │   ├── input                   # 入力データを格納するためのフォルダ
 │   └── output                  # 出力データを格納するためのフォルダ
 ├── scripts                     # 検証スクリプトを格納したフォルダ
 │   ├── eval_classification_mul.py  # 分類モデル(多クラス)の性能評価を実行するスクリプト
 │   ├── eval_classification_bin.py  # 二値分類モデルの性能評価を実行するスクリプト
 │   └── eval_anomaly_detection.py   # 良品学習モデルの性能評価を実行するスクリプト
 ├── tests                       # 単体テストスクリプトを格納したフォルダ
 │
 ├── requirements.txt            # パッケージ一覧を記述したファイル
 └── README.md                   # このファイル
```

* `bevel-ml/config/`フォルダに、設定ファイルのサンプルが同梱されている。
* `bevel-ml/data/input/アノテーション済画像/`フォルダに、検証で用いたアノテーション済画像が同梱されている。

<br><hr>
## 2. 稼働環境
### 2.1. OS
* Windows 11 Pro  
  ※ 開発時に動作確認が取れているものを記載。

### 2.2. 実装言語
* Python 3.12  
  ※ 開発時に動作確認が取れているものを記載。

### 2.3. 外部ライブラリ
本ツールの実行には、[requirements.txt](./requirements.txt) に記載の外部ライブラリを必要とする。  
※ バージョンは開発時に動作確認が取れているものを記載。

<br><hr>

## 3. セットアップ
### 3.1. Python開発環境のインストール
1. Python3.12をインストールする。

### 3.2. Pythonライブラリのインストール
準備したPython実行環境に[上記2.3](#23-外部ライブラリ) に記載のPythonの外部ライブラリをインストールする。   
以下はpipでインストールする場合の手順。 

1. コマンドプロンプトを開く。
2. `bevel-ml`フォルダ（`requirements.txt`が存在するフォルダ）に移動する。
   ```
   > cd bevel-ml
   ```
3. pipでrequirements.txtからインストールする。
   ```
   > pip install -r requirements.txt 
   ```

<br><hr>

## 4. 性能評価の準備手順
分類モデル、良品学習モデルの性能評価を実行する前には、以下の準備を行う。

### 4.1. 入力データの準備
1. 入力となるアノテーション済の画像データを準備し、任意の場所に配置する。
   * 以降の手順では、例として、同梱の`bevel-ml/data/input/アノテーション済画像`フォルダの画像を用いる。

### 4.2. 実行環境の準備 
1. コマンドプロンプトを開く。
2. `bevel-ml/scripts`フォルダに移動する。
   ```
   > cd bevel-ml\scripts
   ```
3. 環境変数`PYTHONPATH`に、プログラム本体`bevel_ml`の親フォルダを指定する。
   ```
   set PYTHONPATH=..
   ```

<br><hr>

## 5. 分類モデル(多クラス)の性能評価の実行手順
分類モデルの性能評価を行うには、以下の手順でスクリプトを実行する。

1. 性能評価に関する設定ファイルを編集する。
   * 以下の設定ファイルのサンプルが同梱されている。
      * `bevel-ml/config/config_mul_clf.yaml`:
         * 各ケースで共通のパラメータを指定する設定ファイル。
         * 出力の評価結果フォルダのパスは、パラメータ`hydra.sweep`で指定できる。
      * `bevel-ml/config/case_mul_clf/{ケース名}.yaml`:
         * 各ケースごとのパラメータを指定する設定ファイル。
         * 複数のファイルを用いることができる。
         * ファイル名(`{ケース名}`)は任意に設定する。
   * 必要に応じて、各設定ファイルを編集し、上書き保存する。
2. `eval_classification_mul.py`を実行し、性能評価を行う。
   ```
   > python eval_classification_mul.py
   ```
3. 設定ファイルで指定したパスに、評価結果のデータが出力される。   
   デフォルトの出力先は以下。
   * `bevel-ml/data/output/{ケース名}/version_{同ケースでの実行数}/`
      * `hparams.yaml`        : 実行時のパラメータ
      * `result.csv`          : 識別精度、処理時間を記録したファイル
      * `roc.png`             : ROC曲線の画像
      * `confmat.png`         : 混同行列(画像枚数)のヒートマップ画像
      * `confmat_norm.png`    : 混同行列(クラス別の画像の割合)のヒートマップ画像
      * `table.png`           : 欠陥種類別の分類結果(画像枚数)画像
      * `table_norm.png`      : 欠陥種類別の分類結果(クラス別の画像の割合)画像
      * `prediction.csv`      : 個々の画像別の推論結果を記録したファイル
      * `checkpoints/`        : 最終エポックのモデルを保存するフォルダ
      * `metrics.csv`         : 学習時の評価指標のログファイル

<br><hr>

## 6. 二値分類モデルの性能評価の実行手順
1. 性能評価に関する設定ファイルを編集する。
   * 以下の設定ファイルのサンプルが同梱されている。
      * `bevel-ml/config/config_bin_clf.yaml`:
         * 各ケースで共通のパラメータを指定する設定ファイル。
         * 出力の評価結果フォルダのパスは、パラメータ`hydra.sweep`で指定できる。
      * `bevel-ml/config/case_bin_clf/{ケース名}.yaml`:
         * 各ケースごとのパラメータを指定する設定ファイル。
         * 複数のファイルを用いることができる。
         * ファイル名(`{ケース名}`)は任意に設定する。
   * 必要に応じて、各設定ファイルを編集し、上書き保存する。
2. `eval_classification_bin.py`を実行し、性能評価を行う。
   ```
   > python eval_classification_bin.py
   ```
3. 結果の出力先は、分類モデル(多クラス)と同様。

## 6. 良品学習モデルの性能評価の実行手順
良品学習モデルの性能評価を行うには、以下の手順でスクリプトを実行する。

1. 性能評価に関する設定ファイルを編集する。
   * 以下の設定ファイルのサンプルが同梱されている。
      * `bevel-ml/config/config_ad.yaml`:
         * 各ケースで共通のパラメータを指定する設定ファイル。
         * 出力の評価結果フォルダのパスは、パラメータ`hydra.sweep`で指定できる。
      * `bevel-ml/config/case_ad/{ケース名}.yaml`:
         * 各ケースごとのパラメータを指定する設定ファイル。
         * 複数のファイルを用いることができる。
         * ファイル名(`{ケース名}`)は任意に設定する。
   * 必要に応じて、各設定ファイルを編集し、上書き保存する。

2. 良品学習モデルの種類別に用意された以下のスクリプトを実行し、性能評価を行う。
   ```
   > python eval_anomaly_detection.py
   ```
3. 設定ファイルで指定したパスに、評価結果のデータが出力される。   
   デフォルトの出力先は以下。
   * `bevel-ml/data/output/{ケース名}/version_{同ケースでの実行数}/`
      * `hparams.yaml`        : 実行時のパラメータ
      * `result.csv`          : 識別精度、処理時間を記録したファイル
      * `roc.png`             : ROC曲線の画像
      * `confmat.png`         : 混同行列(画像枚数)のヒートマップ画像
      * `confmat_norm.png`    : 混同行列(クラス別の画像の割合)のヒートマップ画像
      * `table.png`           : 欠陥種類別の分類結果(画像枚数)画像
      * `table_norm.png`      : 欠陥種類別の分類結果(クラス別の画像の割合)画像
      * `prediction.csv`      : 個々の画像別の推論結果を記録したファイル
      * `checkpoints/`        : 最終エポックのモデルを保存するフォルダ
      * `metrics.csv`         : 学習時の評価指標のログファイル
      * `anomaly_maps/`       : 推論結果の異常度スコアのヒートマップ画像を保存するフォルダ

<br><hr>
以上